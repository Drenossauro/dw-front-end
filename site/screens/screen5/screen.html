<div class="screen-container">
    <div class="emanuel-main-5">
        <div class="emanuel-tempo">
            <div id="emanuel-imagem-tempo">
                <img src="images/tempo.png" alt="tempo escrito">
            </div>
            <div id="emanuel-tempo-escrito">
                <h1 id="time-screen5"><span id="time-display">01:30</span></h1>
            </div>
        </div>

        <div class="emanuel-boxes">
            <div class="emanuel-box-um">
                <div class="emanuel-boxUm-main">
                    <div id="emanuel-boxUm-escrita">
                        <h1>Observe o desenho e adivinhe o que é:</h1>
                    </div>
                    <canvas></canvas>
                </div>
            </div>

            <div class="emanuel-box-dois">
                <div class="emanuel-boxDois-main">
                    <div id="emanuel-boxDois-Escrita">
                        <h1>Enviar palpite</h1>
                    </div>

                    <form action="#" method="post">
                        <div id="emanuel-palpite">
                            <h2>Palpite:</h2>
                            <input type="text" name="guess" id="guess" placeholder="Digite aqui seu palpite">
                        </div>
                        
                        <input type="button" value="Enviar">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    functionCallRegister.register(DRAW_SCREEN, loadScreen5)
    let imgs = []
    let currentPicture = 0
    let time = 90

    function loadScreen5() {
        axios.get(URL_RECEIVE_IMAGE)
            .then(function (response) {
                if (response.data.sucesso == true) {
                    const {url_img1, url_img2, url_img3} = response.data

                    imgs = [
                        url_img1,
                        url_img2,
                        url_img3,
                    ]

                    loadImageInCanvas()
                    initClock()
                } else {
                    throw 'Erro na requisição'
                }
            })
            .catch(function (error) {
                toast(error)
            })
    }
    
    function loadImageInCanvas() {
        const imgURL = imgs[currentPicture]

        const img = new Image()
        img.src = imgURL

        img.onload = () => {
            const canvas = document.querySelector('canvas')
            const ctx = canvas.getContext('2d')
            ctx.clearRect(0, 0, canvas.width, canvas.height)
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
        }
    }
    
    function initClock() {
        const intervalId = setInterval(() => {
            time--
            showTime(time)
            checkIfShouldRevealMore(time)

            if (time <= 0) {
                finishGame(intervalId)
            }
        }, 1000)
    }

    function formatNumberToClock(number) {
        return number < 10 ? `0${number}` : number
    }

    function showTime(time) {
        const minutes = Math.floor(time / 60)
        const seconds = time % 60
        const timeDisplay = `${formatNumberToClock(minutes)}:${formatNumberToClock(seconds)}`

        document.getElementById('time-display').innerHTML = timeDisplay
    }

    function checkIfShouldRevealMore(time) {
        if (
            currentPicture == 0 && time < 60 ||
            currentPicture == 1 && time < 30
        ) {
            currentPicture++
            loadImageInCanvas()
        }
    }

    function finishGame(intervalId) {
        clearInterval(intervalId)
        showScreen(WRONG_GUESS_SCREEN)
    }

    function guess() {
        const value = document.getElementById('guess').value
        document.getElementById('guess').value = ''

        const body = {
            tempo_em_segundos: time,
            palpite: value,
            token_da_sala: token
        }
        
        checkGuess()
    }

    function checkGuess() {
        axios.post(URL_SEND_GUESS, body)
            .then(function (response) {
                if (response.data.sucesso == true) {
                    if (response.data.acertou == true) {
                        const game = JSON.parse(sessionStorage.getItem('game'))
                        const playerLabel = sessionStorage.getItem('player') == 1 ? PLAYER1 : PLAYER2
                        game[playerLabel].pontuacao = response.data.pontuacao
                        sessionStorage.setItem('game', JSON.stringify(game))

                        if (checkEndGame()) {
                            showScreen(END_GAME_SCREEN)
                        } else {
                            showScreen(SUCCESS_GUESS_SCREEN)

                            setTimeout(() => {
                                showScreen(UPLOAD_SCREEN, {tip: response.data['palavra-chave']})
                            }, 1500)
                        }
                    } else {
                        toast('Errado! Tente novamente')
                    }
                } else {
                    throw 'Erro na requisição'
                }
            })
            .catch(function (error) {
                toast(error)
            })
    }
</script>